<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stakeholder PI Status Report â€“ Topic Mix</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <link rel="stylesheet" href="public/tailwind.css">
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background:#f7f8fa; font-family:'Inter',Arial,sans-serif; margin:0;padding:0; }
    .main { max-width:950px; margin:30px auto; background:#fff; border-radius:18px; padding:36px 32px; box-shadow:0 2px 12px #d1d5db70; }
    .btn { background:#6366f1; color:#fff; border:none; border-radius:6px; padding:7px 18px; cursor:pointer; font-size:1em; }
    .chart-section { margin-top:30px; overflow-x:auto; }
  </style>
</head>
<body>
<div class="main">
  <h1>Topic Mix Report</h1>
  <div>
    <label>Version:
      <select id="versionSelect" onchange="switchVersion(this.value)">
        <option value="index.html">Velocity</option>
        <option value="index_throughput.html">Throughput</option>
        <option value="index_throughput_week.html">Weekly Throughput</option>
        <option value="index_disruption.html">Disruption</option>
        <option value="index_topicmix.html">Topic Mix</option>
      </select>
    </label>
  </div>
  <div style="margin-top:20px;">
    <label>Jira Domain: <input id="jiraDomain" value="aldi-sued.atlassian.net" size="28"></label>
  </div>
  <div id="boardRow" style="margin-top:10px; display:none;">
    <label>Boards:
      <select id="boardSelect"></select>
    </label>
  </div>
  <div id="chartSection" class="chart-section" style="display:none;">
    <h2>Completed Story Points by Topic</h2>
    <canvas id="topicMixChart"></canvas>
  </div>
</div>
<script src="src/logger.js"></script>
<script src="src/jira.js"></script>
<script>
function switchVersion(v){ window.location.href = v; }

const DISPLAY_SPRINT_COUNT = 6;
const PI_LABEL_RE = /\b\d{4}_PI\d+_committed\b/i;
const MAIN_DRIVER_RE = /^main[-_ ]?driver$/i;

let boardChoices = null;
let availableBoards = [];
let allSprints = [];
let topicMixChartInstance;
let epicCache = new Map();

document.getElementById('jiraDomain').addEventListener('change', populateBoards);
populateBoards();

async function populateBoards() {
  const domain = document.getElementById('jiraDomain').value.trim();
  if (!domain) return;
  try {
    availableBoards = await Jira.fetchBoardsByJql(domain);
    await loadTopicMix();
  } catch (e) {
    console.error('Failed to load boards', e);
  }
}

function filterRecentSprints(allSprints, excludeIds = [], desiredCount = DISPLAY_SPRINT_COUNT) {
  const excluded = new Set((excludeIds || []).map(String));
  const sorted = allSprints.slice().sort((a,b) => {
    const ad = a.endDate || a.completeDate || a.startDate || '';
    const bd = b.endDate || b.completeDate || b.startDate || '';
    return ad && bd ? new Date(bd) - new Date(ad) : 0;
  });
  return sorted.filter(s => !excluded.has(String(s.id))).slice(0, desiredCount);
}

async function getEpicInfo(domain, epicKey) {
  let cached = epicCache.get(epicKey);
  if (cached) return cached;
  const url = `https://${domain}/rest/api/3/issue/${epicKey}?fields=issuetype,labels`;
  const r = await fetch(url, { credentials:'include' });
  if (!r.ok) return null;
  const j = await r.json();
  const isEpic = (j.fields?.issuetype?.name || '').toLowerCase() === 'epic';
  const labels = j.fields?.labels || [];
  const info = { isEpic, labels };
  epicCache.set(epicKey, info);
  return info;
}

async function fetchTopicMixData(jiraDomain, boardNums = []) {
  const combined = {};
  const issueCache = new Map();

  await Promise.all(boardNums.map(async boardNum => {
    const url = `https://${jiraDomain}/rest/greenhopper/1.0/rapid/charts/velocity?rapidViewId=${boardNum}`;
    let data = {};
    const resp = await fetch(url, { credentials:'include' });
    if (resp.ok) data = await resp.json();
    let closed = (data.sprints || []).filter(s => s.state === 'CLOSED' && s.startDate && String(s.originBoardId) === String(boardNum));
    if (!closed.length) {
      let all = [];
      let startAt=0, maxResults=50, loops=0;
      while (true) {
        const sUrl = `https://${jiraDomain}/rest/agile/1.0/board/${boardNum}/sprint?state=closed&maxResults=${maxResults}&startAt=${startAt}`;
        const sResp = await fetch(sUrl, { credentials:'include' });
        if (!sResp.ok) break;
        const sData = await sResp.json();
        const vals = sData.values || [];
        all = all.concat(vals);
        startAt += vals.length;
        loops++;
        if (sData.isLast || vals.length < maxResults || loops > 100) break;
      }
      closed = all.filter(s => (s.state || '').toUpperCase() === 'CLOSED' && s.startDate && String(s.originBoardId) === String(boardNum));
    }
    await Promise.all(closed.map(async s => {
      const surl = `https://${jiraDomain}/rest/greenhopper/1.0/rapid/charts/sprintreport?rapidViewId=${boardNum}&sprintId=${s.id}`;
      const r = await fetch(surl, { credentials:'include' });
      if (!r.ok) return;
      const d = await r.json();
      const events = [];
      const collect = (arr, completed=false) => {
        (arr || []).forEach(it => {
          events.push({ key: it.key, points: it.estimateStatistic?.statFieldValue?.value || 0, completed });
        });
      };
      collect(d.contents.completedIssues, true);
      collect(d.contents.incompleteIssues, false);
      collect(d.contents.puntedIssues, false);
      await Promise.all(events.map(async ev => {
        let cached = issueCache.get(ev.key);
        let team, parentKey, topicType = 'other';
        if (cached) ({ team, parentKey, topicType } = cached);
        else {
          const u = `https://${jiraDomain}/rest/api/3/issue/${ev.key}?fields=customfield_12600,parent`;
          const ir = await fetch(u, { credentials:'include' });
          if (!ir.ok) return;
          const id = await ir.json();
          team = (id.fields?.customfield_12600 || []).join(', ');
          parentKey = id.fields?.parent?.key;
          if (parentKey) {
            const epic = await getEpicInfo(jiraDomain, parentKey);
            const labels = epic?.labels || [];
            if (labels.some(l => MAIN_DRIVER_RE.test(l))) topicType = 'maindriver';
            else if (labels.some(l => PI_LABEL_RE.test(l))) topicType = 'pi';
          }
          issueCache.set(ev.key, { team, parentKey, topicType });
        }
        ev.team = team;
        ev.topicType = topicType;
      }));
      const existing = combined[s.id] || { id: s.id, boardId: boardNum, name: s.name, startDate: s.startDate, events: [] };
      existing.events = existing.events.concat(events);
      combined[s.id] = existing;
    }));
  }));
  return { sprints: Object.values(combined) };
}
function renderBoardSelect(boards) {
  const select = document.getElementById('boardSelect');
  select.innerHTML = '<option value="">All Boards</option>' + boards.map(b => `<option value="${b.id}">${b.name}</option>`).join('');
  if (boardChoices) boardChoices.destroy();
  boardChoices = new Choices(select, { shouldSort:true });
  document.getElementById('boardRow').style.display = boards.length ? '' : 'none';
  select.addEventListener('change', renderChart);
}

function renderChart() {
  if (!allSprints.length) return;
  const selectedBoard = boardChoices ? boardChoices.getValue(true) : '';
  const sprints = selectedBoard ? allSprints.filter(s => String(s.boardId) === String(selectedBoard)) : allSprints;
  const sprintLabels = sprints.map(s => s.name);
  const chartWidth = Math.max(sprintLabels.length * 120, 600);
  const canvas = document.getElementById('topicMixChart');
  canvas.width = chartWidth;
  canvas.height = 300;
  const sums = sprints.map(s => {
    const acc = { maindriver:0, pi:0, other:0 };
    (s.events || []).forEach(ev => {
      if (!ev.completed) return;
      acc[ev.topicType] = (acc[ev.topicType] || 0) + (ev.points || 0);
    });
    return acc;
  });
  const md = sums.map(s => s.maindriver || 0);
  const pi = sums.map(s => s.pi || 0);
  const other = sums.map(s => s.other || 0);
  if (topicMixChartInstance) topicMixChartInstance.destroy();
  const ctx = canvas.getContext('2d');
  topicMixChartInstance = new Chart(ctx, {
    type:'bar',
    data:{
      labels:sprintLabels,
      datasets:[
        { label:'Main Driver', data:md, backgroundColor:'#f59e0b', stack:'topics' },
        { label:'PI Topics', data:pi, backgroundColor:'#3b82f6', stack:'topics' },
        { label:'Other Topics', data:other, backgroundColor:'#10b981', stack:'topics' }
      ]
    },
    options:{
      responsive:false,
      maintainAspectRatio:false,
      scales:{ x:{ stacked:true, offset:true }, y:{ stacked:true, beginAtZero:true, title:{ display:true, text:'Completed Story Points' } } },
      plugins:{ legend:{ position:'bottom' } }
    }
  });
  document.getElementById('chartSection').style.display = '';
}

async function loadTopicMix() {
  const jiraDomain = document.getElementById('jiraDomain').value.trim();
  const boards = availableBoards.map(b => b.id);
  if (!jiraDomain || !boards.length) { alert('Enter Jira domain'); return; }
  const { sprints } = await fetchTopicMixData(jiraDomain, boards);
  allSprints = filterRecentSprints(sprints).reverse();
  renderBoardSelect(availableBoards);
  renderChart();
}

document.getElementById('versionSelect').value = 'index_topicmix.html';
</script>
</body>
</html>
