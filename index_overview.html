<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Issue Overview</title>
  <style>
    body { background: #f7f8fa; font-family: 'Inter', Arial, sans-serif; margin:0; padding:0; }
    .main { max-width: 950px; margin: 30px auto 40px auto; background:#fff; border-radius:18px; box-shadow:0 2px 12px #d1d5db70; padding:36px 32px; }
    h1 { font-size:2.3em; margin:0 0 0.7em 0; font-weight:600; }
    .filters label { margin-right:1em; }
    .btn { background:#6366f1; color:#fff; border:none; border-radius:6px; padding:7px 18px; cursor:pointer; font-size:1em; margin:0 10px 8px 0; }
    table { border-collapse: collapse; margin-top:1em; width:100%; }
    th, td { border:1px solid #ccc; padding:4px 8px; text-align:left; }
    th { background:#eee; }
  </style>
</head>
<body>
  <div class="main">
    <h1>Issue Overview</h1>
    <div style="margin-bottom:10px;">
      <label>Version:
        <select id="versionSelect" onchange="switchVersion(this.value)">
          <option value="index.html">Velocity</option>
          <option value="index_throughput.html">Throughput</option>
          <option value="index_throughput_week.html">Weekly Throughput</option>
          <option value="index_overview.html">Overview</option>
          <option value="index_disruption.html">Disruption</option>
        </select>
      </label>
    </div>
    <div class="jira-inputs" style="margin-bottom:10px;">
      <label>Jira Domain:
        <input id="jiraDomain" value="aldi-sued.atlassian.net" size="28">
      </label>
      <label>JQL:
        <input id="jqlInput" size="40" value="project = MC AND statusCategory = Done">
      </label>
      <button class="btn" onclick="loadIssues()">Load Issues</button>
    </div>
    <div class="filters">
      <label>Team:
        <select id="teamFilter" onchange="applyFilters()">
          <option value="">All</option>
        </select>
      </label>
      <label>Product:
        <select id="productFilter" onchange="applyFilters()">
          <option value="">All</option>
        </select>
      </label>
      <label>Project:
        <select id="projectFilter" onchange="applyFilters()">
          <option value="">All</option>
        </select>
      </label>
    </div>
    <div id="metrics" style="margin-top:1.5em;"></div>
    <div id="issues"></div>
  </div>
<script>
const versionEl = document.getElementById('versionSelect');
versionEl.value = 'index_overview.html';
function switchVersion(page){ if(page !== 'index_overview.html') location.href = page; }
let allIssues = [];
let jiraDomain = '';


async function loadIssues(){
  jiraDomain = document.getElementById('jiraDomain').value.trim();
  const jql = encodeURIComponent(document.getElementById('jqlInput').value.trim());
  if(!jiraDomain || !jql){ alert('Enter Jira domain and JQL'); return; }
  const fields='created,resolutiondate,customfield_10002,customfield_12600,project';
  let startAt=0, issues=[];
  while(true){
    const url=`https://${jiraDomain}/rest/api/3/search?jql=${jql}&fields=${fields}&startAt=${startAt}&maxResults=100`;
    try {
      const resp=await fetch(url,{credentials:'include'});
      if(!resp.ok){
        const msg = await resp.text();
        alert('Failed to fetch issues: ' + msg);
        return;
      }
      const data=await resp.json();
      issues=issues.concat(data.issues||[]);
      startAt+=data.issues?data.issues.length:0;
      if(!data.issues || startAt>=(data.total||0)) break;
    } catch(e){ alert('Error fetching issues'); return; }
  }
  allIssues=issues.map(it=>({
    id: it.key,
    team: (it.fields.customfield_12600||[]).join(', '),
    product: (it.fields.project && it.fields.project.name) || '',
    project: (it.fields.project && it.fields.project.key) || '',
    created: it.fields.created,
    resolved: it.fields.resolutiondate,
    points: Number(it.fields.customfield_10002)||0
  }));
  populateFilters();
  applyFilters();
}
function isoWeekNumber(dt){
  const d = new Date(dt); d.setHours(0,0,0,0);
  d.setDate(d.getDate()+4-(d.getDay()||7));
  const yearStart = new Date(d.getFullYear(),0,1);
  const weekNo = Math.ceil(((d-yearStart)/86400000+1)/7);
  return `${d.getFullYear()}-W${String(weekNo).padStart(2,'0')}`;
}
function calculateMetrics(issues){
  if(!issues.length) return {avg:0, tp:{}, vel:{}};
  let total=0; const tp={}, vel={};
  for(const it of issues){
    const c=new Date(it.created), r=new Date(it.resolved);
    total += (r-c)/86400000;
    const w=isoWeekNumber(it.resolved);
    tp[w]=(tp[w]||0)+1;
    vel[w]=(vel[w]||0)+(Number(it.points)||0);
  }
  return {avg: total/issues.length, tp, vel};
}
function renderMetrics(metrics){
  const div=document.getElementById('metrics');
  let html=`<b>Average Cycle Time:</b> ${metrics.avg.toFixed(2)} days`;
  html += '<h3>Throughput Per Week</h3><table><tr><th>Week</th><th>Count</th></tr>';
  for(const [w,c] of Object.entries(metrics.tp)) html+=`<tr><td>${w}</td><td>${c}</td></tr>`;
  html += '</table><h3>Velocity Per Week</h3><table><tr><th>Week</th><th>Points</th></tr>';
  for(const [w,p] of Object.entries(metrics.vel)) html+=`<tr><td>${w}</td><td>${p}</td></tr>`;
  html += '</table>';
  div.innerHTML=html;
}
function renderIssues(issues){
  const byWeek={};
  issues.forEach(it=>{ const w=isoWeekNumber(it.resolved); (byWeek[w]=byWeek[w]||[]).push(it); });
  let html='<h3>Issues</h3>';
  for(const week of Object.keys(byWeek).sort()){
    html+=`<h4>${week}</h4><table><tr><th>ID</th><th>Created</th><th>Resolved</th><th>Points</th><th>Team</th><th>Product</th><th>Project</th></tr>`;
    byWeek[week].forEach(it=>{ html+=`<tr><td>${it.id}</td><td>${it.created}</td><td>${it.resolved}</td><td>${it.points||''}</td><td>${it.team}</td><td>${it.product}</td><td>${it.project}</td></tr>`; });
    html+='</table>';
  }
  document.getElementById('issues').innerHTML=html;
}
function populateFilters(){
  const teams=new Set(), products=new Set(), projects=new Set();
  allIssues.forEach(it=>{ teams.add(it.team); products.add(it.product); projects.add(it.project); });
  const addOpts=(sel,vals)=>{ const el=document.getElementById(sel); vals.forEach(v=>{ const op=document.createElement('option'); op.value=v; op.textContent=v; el.appendChild(op); }); };
  addOpts('teamFilter',Array.from(teams).sort());
  addOpts('productFilter',Array.from(products).sort());
  addOpts('projectFilter',Array.from(projects).sort());
}
function applyFilters(){
  const t=document.getElementById('teamFilter').value;
  const p=document.getElementById('productFilter').value;
  const pr=document.getElementById('projectFilter').value;
  const filtered=allIssues.filter(it=>{
    if(t && it.team!==t) return false;
    if(p && it.product!==p) return false;
    if(pr && it.project!==pr) return false;
    return true;
  });
  const metrics=calculateMetrics(filtered);
  renderMetrics(metrics);
  renderIssues(filtered);
}

</script>
</body>
</html>
