<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stakeholder PI Status Report â€“ Disruption KPI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    body { background: #f7f8fa; font-family: 'Inter', Arial, sans-serif; margin:0; padding:0; }
    .main { max-width: 950px; margin: 30px auto; background:#fff; border-radius:18px; padding:36px 32px; box-shadow:0 2px 12px #d1d5db70; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #e5e7eb; padding: 6px 10px; text-align:left; font-size:0.95em; }
    th { background:#e0e7ef; }
    .btn { background:#6366f1; color:#fff; border:none; border-radius:6px; padding:7px 18px; cursor:pointer; font-size:1em; }
  </style>
</head>
<body>
<div class="main">
  <h1>Disruption KPI Report</h1>
  <div>
    <label>Version:
      <select id="versionSelect" onchange="switchVersion(this.value)">
        <option value="index.html">Velocity</option>
        <option value="index_throughput.html">Throughput</option>
        <option value="index_throughput_week.html">Weekly Throughput</option>
        <option value="index_disruption.html">Disruption</option>
      </select>
    </label>
  </div>
  <div style="margin-top:20px;">
    <label>Jira Domain: <input id="jiraDomain" value="aldi-sued.atlassian.net" size="28"></label>
    <label style="margin-left:10px;">Board Number: <input id="boardNum" size="5"></label>
    <button class="btn" onclick="loadDisruption()">Load Data</button>
  </div>
  <table>
    <thead>
      <tr>
        <th>Sprint</th>
        <th>Planned</th>
        <th>Completed</th>
        <th>Other</th>
        <th>Pulled In</th>
        <th>Blocked</th>
        <th>Type Changed</th>
        <th>Moved Out</th>
      </tr>
    </thead>
    <tbody id="metricsBody"></tbody>
  </table>
</div>
<script src="src/disruption.js"></script>
<script>
  function switchVersion(v){ window.location.href = v; }

  async function fetchDisruptionData(jiraDomain, boardNum) {
    const url = `https://${jiraDomain}/rest/greenhopper/1.0/rapid/charts/velocity?rapidViewId=${boardNum}`;
    try {
      const resp = await fetch(url, { credentials: 'include' });
      if (!resp.ok) {
        alert('Failed to fetch velocity report. Are you logged in to Jira?');
        return [];
      }
      const data = await resp.json();
      let closed = (data.sprints || []).filter(s => s.state === 'CLOSED');
      closed.sort((a,b) => {
        const ad = a.endDate || a.completeDate || a.startDate || '';
        const bd = b.endDate || b.completeDate || b.startDate || '';
        return ad && bd ? new Date(bd) - new Date(ad) : 0;
      });
      closed = closed.slice(0,6);
      const results = [];
      for (const s of closed) {
        const surl = `https://${jiraDomain}/rest/greenhopper/1.0/rapid/charts/sprintreport?rapidViewId=${boardNum}&sprintId=${s.id}`;
        try {
          const r = await fetch(surl, { credentials: 'include' });
          if (!r.ok) continue;
          const d = await r.json();
          const addedMap = d.contents.issueKeysAddedDuringSprint || {};
          const issues = [];
          const collect = (arr, movedOut=false) => {
            (arr || []).forEach(it => {
              issues.push({
                key: it.key,
                points: it.estimateStatistic?.statFieldValue?.value || 0,
                addedAfterStart: !!addedMap[it.key],
                blocked: !!it.flagged,
                movedOut
              });
            });
          };
          collect(d.contents.completedIssues, false);
          collect(d.contents.issuesNotCompletedInCurrentSprint, false);
          collect(d.contents.puntedIssues, true);

          const entry = data.velocityStatEntries?.[s.id] || {};
          let planned = entry.estimated?.value || 0;
          let completed = entry.completed?.value || 0;
          let other = completed > planned ? completed - planned : 0;

          if (!completed) {
            completed = d.contents?.completedIssuesEstimateSum?.value || 0;
            planned = completed +
                      (d.contents?.incompletedIssuesEstimateSum?.value || 0) +
                      (d.contents?.puntedIssuesEstimateSum?.value || 0);
            other = completed > planned ? completed - planned : 0;
          }
          const sprintStart = s.startDate ? new Date(s.startDate) : null;
          const sprintEnd = s.completeDate ? new Date(s.completeDate) : (s.endDate ? new Date(s.endDate) : null);
          await Promise.all(issues.map(async it => {
            try {
              const u = `https://${jiraDomain}/rest/api/3/issue/${it.key}?expand=changelog&fields=issuetype`;
              const ir = await fetch(u, { credentials: 'include' });
              if (!ir.ok) return;
              const id = await ir.json();
              const histories = id.changelog?.histories || [];
              for (const h of histories) {
                const chDate = new Date(h.created);
                if (sprintStart && sprintEnd && chDate >= sprintStart && chDate <= sprintEnd) {
                  for (const item of h.items) {
                    if (item.field === 'issuetype') { it.typeChanged = true; return; }
                  }
                }
              }
            } catch(e) {}
          }));
          results.push({ name: s.name, issues, planned, completed, other });
        } catch (e) { console.error('sprint fetch failed', e); }
      }
      return results;
    } catch (e) {
      console.error('Failed to fetch disruption data', e);
      alert('Failed to fetch disruption data.');
      return [];
    }
  }

  function renderTable(data) {
    const tbody = document.getElementById('metricsBody');
    let html = '';
    data.forEach(sprint => {
      const metrics = Disruption.calculateDisruptionMetrics(sprint.issues);
      html += `<tr>
        <td>${sprint.name}</td>
        <td>${sprint.planned || 0}</td>
        <td>${sprint.completed || 0}</td>
        <td>${sprint.other || 0}</td>
        <td>${metrics.pulledIn}</td>
        <td>${metrics.blocked}</td>
        <td>${metrics.typeChanged || 0}</td>
        <td>${metrics.movedOut}</td>
      </tr>`;
    });
    tbody.innerHTML = html;
  }

  async function loadDisruption() {
    const jiraDomain = document.getElementById('jiraDomain').value.trim();
    const boardNum = document.getElementById('boardNum').value.trim();
    if (!jiraDomain || !boardNum) {
      alert('Enter Jira domain and board number.');
      return;
    }
    const data = await fetchDisruptionData(jiraDomain, boardNum);
    renderTable(data);
  }

  document.getElementById('versionSelect').value = 'index_disruption.html';
</script>
</body>
</html>
