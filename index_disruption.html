<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stakeholder Report – Disruption KPIs</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    body { background: #f7f8fa; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
    .main { max-width: 950px; margin: 30px auto 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 12px #d1d5db70; padding: 36px 32px; }
    h1 { font-size: 2.3em; margin:0 0 0.7em 0; font-weight: 600; }
    .btn { background: #6366f1; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; cursor: pointer; font-size:1em; margin: 0 10px 8px 0;}
    .btn:disabled { background: #aaa; }
    table { border-collapse: collapse; width: 100%; margin-top:20px; }
    th, td { border: 1px solid #e5e7eb; padding:4px 7px; font-size:0.95em; text-align:left; }
    th { background:#e0e7ef; }
  </style>
</head>
<body>
  <div class="main">
    <h1>Stakeholder Report – Disruption KPIs</h1>
    <div style="margin-bottom:10px;">
      <label>Version:
        <select id="versionSelect" onchange="switchVersion(this.value)">
          <option value="index.html">Velocity</option>
          <option value="index_throughput.html">Throughput</option>
          <option value="index_throughput_week.html">Weekly Throughput</option>
          <option value="index_overview.html">Overview</option>
          <option value="index_disruption.html">Disruption</option>
        </select>
      </label>
    </div>
    <div style="margin-bottom:20px;">
      <label>Jira Domain: <input id="jiraDomain" value="aldi-sued.atlassian.net" size="28"></label>
      <button class="btn" onclick="loadBoards()">Load Boards</button>
    </div>
    <div style="margin-bottom:20px;">
      <label for="boardSelect" class="section-title">Select Team Board:</label>
      <select id="boardSelect"></select>
      <button class="btn" onclick="loadReport()">Load Report</button>
    </div>
    <div id="stats"></div>
    <table id="resultTable" style="display:none;">
      <thead>
        <tr>
          <th>Sprint</th>
          <th>Velocity</th>
          <th>Pulled</th>
          <th>Blocked</th>
          <th>Moved</th>
          <th>Type Changed</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script src="src/disruption.js"></script>
  <script>
    let jiraDomain = '';

    function switchVersion(page) {
      if (location.pathname.endsWith(page)) return;
      location.href = page;
    }

    document.getElementById('versionSelect').value = 'index_disruption.html';

    async function loadBoards() {
      jiraDomain = document.getElementById('jiraDomain').value.trim();
      if (!jiraDomain) return alert('Enter Jira domain');
      try {
        const resp = await fetch(`https://${jiraDomain}/rest/agile/1.0/board?maxResults=1000`, { credentials:'include' });
        if (!resp.ok) return;
        const data = await resp.json();
        const boards = (data.values || []).sort((a,b)=>a.name.localeCompare(b.name));
        const sel = document.getElementById('boardSelect');
        sel.innerHTML = '';
        boards.forEach(b => {
          const opt = document.createElement('option');
          opt.value = b.id;
          opt.textContent = `${b.name} (${b.location.projectKey})`;
          sel.appendChild(opt);
        });
        if (sel.choicesInstance) {
          sel.choicesInstance.destroy();
        }
        // eslint-disable-next-line no-undef
        sel.choicesInstance = new Choices(sel);
      } catch (e) {}
    }

    async function fetchIssuesForSprint(boardId, sprintId) {
      const jql = encodeURIComponent(`Sprint = ${sprintId}`);
      const url = `https://${jiraDomain}/rest/api/2/search?jql=${jql}&expand=changelog&maxResults=1000`;
      const resp = await fetch(url, { credentials:'include' });
      if (!resp.ok) return [];
      const data = await resp.json();
      return data.issues || [];
    }

    async function loadReport() {
      const boardId = document.getElementById('boardSelect').value;
      if (!boardId) return alert('Select a board');
      const sprintUrl = `https://${jiraDomain}/rest/agile/1.0/board/${boardId}/sprint?state=closed&maxResults=50`;
      const resp = await fetch(sprintUrl, { credentials:'include' });
      if (!resp.ok) return alert('Failed to fetch sprints');
      const data = await resp.json();
      let sprints = data.values || [];
      sprints = sprints.filter(s=>s.startDate).sort((a,b)=>new Date(b.startDate)-new Date(a.startDate)).slice(0,12).reverse();
      const results = [];
      for (const s of sprints) {
        const issues = await fetchIssuesForSprint(boardId, s.id);
        const velocity = issues.reduce((sum,it)=>sum+(it.fields?.customfield_10016||0),0);
        const disruptions = window.aggregateDisruptions(issues.map(i=>({ changelog: i.changelog.histories.map(h=>({ field:h.items[0]?.field, from:h.items[0]?.fromString, to:h.items[0]?.toString, created:h.created })) })), s.startDate);
        results.push({ sprint:s.name, velocity, ...disruptions });
      }
      const velocities = results.map(r=>r.velocity);
      const avg = velocities.reduce((a,b)=>a+b,0)/velocities.length || 0;
      const sd = Math.sqrt(velocities.reduce((s,v)=>s+(v-avg)**2,0)/velocities.length || 0);
      const stats = document.getElementById('stats');
      stats.textContent = `Average Velocity: ${avg.toFixed(2)} | Standard Deviation: ${sd.toFixed(2)}`;
      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';
      results.forEach(r=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.sprint}</td><td>${r.velocity}</td><td>${r.pulled}</td><td>${r.blocked}</td><td>${r.moved}</td><td>${r.typeChanged}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('resultTable').style.display = '';
    }

    loadBoards();
  </script>
</body>
</html>
