<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stakeholder PI Status Report â€“ Disruption KPI</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <style>
    body { background: #f7f8fa; font-family: 'Inter', Arial, sans-serif; margin:0; padding:0; }
    .main { max-width: 950px; margin: 30px auto; background:#fff; border-radius:18px; padding:36px 32px; box-shadow:0 2px 12px #d1d5db70; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #e5e7eb; padding: 6px 10px; text-align:left; font-size:0.95em; }
    th { background:#e0e7ef; }
    .btn { background:#6366f1; color:#fff; border:none; border-radius:6px; padding:7px 18px; cursor:pointer; font-size:1em; }
    .details-toggle { margin:10px 0 6px 0; }
    .story-table { border-collapse: collapse; width: 100%; margin: 6px 0 18px 0; }
    .story-table th, .story-table td { border: 1px solid #e5e7eb; padding: 4px 7px; font-size: 0.95em; text-align:left; }
    .story-table th { background:#e0e7ef; }
  </style>
</head>
<body>
<div class="main">
  <h1>Disruption KPI Report</h1>
  <div>
    <label>Version:
      <select id="versionSelect" onchange="switchVersion(this.value)">
        <option value="index.html">Velocity</option>
        <option value="index_throughput.html">Throughput</option>
        <option value="index_throughput_week.html">Weekly Throughput</option>
        <option value="index_disruption.html">Disruption</option>
      </select>
    </label>
  </div>
  <div style="margin-top:20px;">
    <label>Jira Domain: <input id="jiraDomain" value="aldi-sued.atlassian.net" size="28"></label>
    <label style="margin-left:10px;">Boards:
      <select id="boardNum" multiple></select>
    </label>
    <button class="btn" onclick="loadDisruption()">Load Data</button>
  </div>
  <div id="logPanel" style="display:none; white-space:pre-wrap; font-size:0.85em; background:#f3f4f6; border:1px solid #e5e7eb; padding:6px; margin:10px 0; max-height:150px; overflow:auto;"></div>
  <table>
    <thead>
      <tr>
        <th>Sprint</th>
        <th>Initially Planned</th>
        <th>Completed</th>
        <th>Other</th>
        <th>Pulled In</th>
        <th>Blocked</th>
        <th>Type Changed</th>
        <th>Moved Out</th>
        <th>Details</th>
      </tr>
    </thead>
    <tbody id="metricsBody"></tbody>
  </table>
</div>
<script src="src/logger.js"></script>
<script src="src/jira.js"></script>
<script>
  function appendLog(level, args) {
    const el = document.getElementById('logPanel');
    if (!el) return;
    const msg = args.map(a => typeof a === 'object' ? JSON.stringify(a) : String(a)).join(' ');
    el.textContent += `[${level}] ${msg}\n`;
    el.scrollTop = el.scrollHeight;
    el.style.display = '';
  }
  Logger.setLevel('debug');
  Logger.setListener((level, args) => appendLog(level, args));
</script>
<script src="src/disruption.js"></script>
<script>
  function switchVersion(v){ window.location.href = v; }

  const boardSelect = document.getElementById('boardNum');
  let boardChoices = new Choices(boardSelect, { removeItemButton: true });

  async function populateBoards() {
    const domain = document.getElementById('jiraDomain').value.trim();
    if (!domain) return;
    try {
      const boards = await Jira.fetchBoardsByJql(domain);
      boardChoices.clearChoices();
      boardChoices.setChoices(boards.map(b => ({ value: b.id, label: b.name })), 'value', 'label', true);
    } catch (e) {
      Logger.error('Failed to load boards', e);
    }
  }

  document.getElementById('jiraDomain').addEventListener('change', populateBoards);
  populateBoards();

    async function fetchDisruptionData(jiraDomain, boardNums = []) {
      Logger.info('Fetching disruption data for boards', boardNums.join(','));
      const combined = {};
      try {
        await Promise.all(boardNums.map(async boardNum => {
          const url = `https://${jiraDomain}/rest/greenhopper/1.0/rapid/charts/velocity?rapidViewId=${boardNum}`;
          const resp = await fetch(url, { credentials: 'include' });
          if (!resp.ok) {
            Logger.error('Failed to fetch velocity report', resp.status);
            return;
          }
          const data = await resp.json();
          let closed = (data.sprints || []).filter(s => s.state === 'CLOSED' && s.startDate);
          closed.sort((a, b) => new Date(b.startDate) - new Date(a.startDate));
          closed = closed.slice(0, 12);
          for (const s of closed) {
            const surl = `https://${jiraDomain}/rest/greenhopper/1.0/rapid/charts/sprintreport?rapidViewId=${boardNum}&sprintId=${s.id}`;
            try {
              const r = await fetch(surl, { credentials: 'include' });
              if (!r.ok) continue;
              const d = await r.json();
              const addedMap = d.contents.issueKeysAddedDuringSprint || {};
              const addedKeys = new Set(Object.values(addedMap));
              const events = [];
              const collect = (arr, movedOut = false) => {
                (arr || []).forEach(it => {
                  events.push({
                    key: it.key,
                    points: it.estimateStatistic?.statFieldValue?.value || 0,
                    addedAfterStart: addedKeys.has(it.key),
                    blocked: !!it.flagged,
                    movedOut
                  });
                });
              };
              collect(d.contents.completedIssues, false);
              collect(d.contents.issuesNotCompletedInCurrentSprint, false);
              collect(d.contents.puntedIssues, true);

              const entry = data.velocityStatEntries?.[s.id] || {};
              let completed = entry.completed?.value || 0;
              let completedSource = 'velocityStatEntries.completed';
              if (!completed) {
                completed = d.contents?.completedIssuesEstimateSum?.value || 0;
                completedSource = 'completedIssuesEstimateSum';
              }
              let initiallyPlanned = entry.estimated?.value || 0;
              let initiallyPlannedSource = 'velocityStatEntries.estimated';
              const sprintStart = s.startDate ? new Date(s.startDate) : null;
              const sprintEnd = s.completeDate ? new Date(s.completeDate) : (s.endDate ? new Date(s.endDate) : null);
              await Promise.all(events.map(async ev => {
                try {
                  const u = `https://${jiraDomain}/rest/api/3/issue/${ev.key}?expand=changelog`;
                  const ir = await fetch(u, { credentials: 'include' });
                  if (!ir.ok) return;
                  const id = await ir.json();
                  const histories = id.changelog?.histories || [];
                  ev.events = [];
                  for (const h of histories) {
                    const chDate = new Date(h.created);
                    if (sprintStart && sprintEnd && chDate >= sprintStart && chDate <= sprintEnd) {
                      ev.events = ev.events.concat(h.items || []);
                      for (const item of h.items) {
                        if (item.field === 'issuetype') ev.typeChanged = true;
                      }
                    }
                  }
                } catch (e) {}
              }));
              if (!initiallyPlanned) {
                initiallyPlanned = events.filter(ev => !ev.addedAfterStart)
                                         .reduce((sum, ev) => sum + ev.points, 0);
                initiallyPlannedSource = 'sum of events not added after start';
              }
              const other = completed > initiallyPlanned ? completed - initiallyPlanned : 0;
              if (!combined[s.name]) {
                combined[s.name] = { name: s.name, events: [], initiallyPlanned: 0, completed: 0, other: 0, initiallyPlannedSource, completedSource };
              }
              combined[s.name].events = combined[s.name].events.concat(events);
              combined[s.name].initiallyPlanned += initiallyPlanned || 0;
              combined[s.name].completed += completed || 0;
              combined[s.name].other += other || 0;
            } catch (e) {
              Logger.error('sprint fetch failed', e);
            }
          }
        }));
        Logger.info('Disruption data fetched for', Object.keys(combined).length, 'sprints');
        return Object.values(combined);
      } catch (e) {
        Logger.error('Failed to fetch disruption data', e);
        alert('Failed to fetch disruption data.');
        return [];
      }
    }

  function renderTable(data) {
    const tbody = document.getElementById('metricsBody');
    let html = '';
    data.forEach((sprint, idx) => {
      const metrics = Disruption.calculateDisruptionMetrics(sprint.events);
      const detailsId = `details-${idx}`;
      html += `<tr>
        <td>${sprint.name}</td>
        <td title="${sprint.initiallyPlannedSource}">${sprint.initiallyPlanned || 0}</td>
        <td title="${sprint.completedSource}">${sprint.completed || 0}</td>
        <td title="completed minus initially planned">${sprint.other || 0}</td>
        <td title="${metrics.pulledInIssues.join(', ')}">${metrics.pulledIn || 0} (${metrics.pulledInCount || 0})</td>
        <td title="${metrics.blockedIssues.join(', ')}">${metrics.blocked || 0} (${metrics.blockedCount || 0})</td>
        <td title="${metrics.typeChangedIssues.join(', ')}">${metrics.typeChanged || 0} (${metrics.typeChangedCount || 0})</td>
        <td title="${metrics.movedOutIssues.join(', ')}">${metrics.movedOut || 0} (${metrics.movedOutCount || 0})</td>
        <td><button class="btn details-toggle" onclick="toggleDetails('${detailsId}', this)">Show Details</button></td>
      </tr>`;
      html += `<tr id="${detailsId}" style="display:none"><td colspan="9">
        <table class="story-table">
          <thead><tr><th>Metric</th><th>Stories</th></tr></thead>
          <tbody>
            <tr><td>Pulled In</td><td>${metrics.pulledInIssues.join(', ') || '-'}</td></tr>
            <tr><td>Blocked</td><td>${metrics.blockedIssues.join(', ') || '-'}</td></tr>
            <tr><td>Type Changed</td><td>${metrics.typeChangedIssues.join(', ') || '-'}</td></tr>
            <tr><td>Moved Out</td><td>${metrics.movedOutIssues.join(', ') || '-'}</td></tr>
          </tbody>
        </table>
      </td></tr>`;
    });
    tbody.innerHTML = html;
  }

  function toggleDetails(id, btn) {
    const row = document.getElementById(id);
    if (row) {
      const hidden = row.style.display === 'none';
      row.style.display = hidden ? '' : 'none';
      if (btn) btn.textContent = hidden ? 'Hide Details' : 'Show Details';
    }
  }

  async function loadDisruption() {
    const jiraDomain = document.getElementById('jiraDomain').value.trim();
    const boards = boardChoices ? boardChoices.getValue(true) : [];
    if (!jiraDomain || !boards.length) {
      alert('Enter Jira domain and select boards.');
      return;
    }
    Logger.info('Loading disruption report for boards', boards.join(','));
    const data = await fetchDisruptionData(jiraDomain, boards);
    renderTable(data);
    Logger.info('Disruption report rendered');
  }

  document.getElementById('versionSelect').value = 'index_disruption.html';
</script>
</body>
</html>
