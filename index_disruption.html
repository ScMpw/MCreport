<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Stakeholder Report â€“ Disruption KPIs</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background: #f7f8fa; font-family: 'Inter', Arial, sans-serif; margin: 0; padding: 0; }
    .main { max-width: 950px; margin: 30px auto 40px auto; background: #fff; border-radius: 18px; box-shadow: 0 2px 12px #d1d5db70; padding: 36px 32px; }
    h1 { font-size: 2.3em; margin:0 0 0.7em 0; font-weight: 600; }
    .btn { background: #6366f1; color: #fff; border: none; border-radius: 6px; padding: 7px 18px; cursor: pointer; font-size:1em; margin: 0 10px 8px 0;}
    .btn:disabled { background: #aaa; }
    table { border-collapse: collapse; width: 100%; margin-top:20px; }
    th, td { border: 1px solid #e5e7eb; padding:4px 7px; font-size:0.95em; text-align:left; }
    th { background:#e0e7ef; }
  </style>
</head>
<body>
  <div class="main">
    <h1>Stakeholder Report â€“ Disruption KPIs</h1>
    <div style="margin-bottom:10px;">
      <label>Version:
        <select id="versionSelect" onchange="switchVersion(this.value)">
          <option value="index.html">Velocity</option>
          <option value="index_throughput.html">Throughput</option>
          <option value="index_throughput_week.html">Weekly Throughput</option>
          <option value="index_overview.html">Overview</option>
          <option value="index_disruption.html">Disruption</option>
        </select>
      </label>
    </div>
    <div>
      <label>Jira Domain: <input id="jiraDomain" value="aldi-sued.atlassian.net" size="28"></label>
      <label>Board Number:
        <input id="boardNum" size="5">
      </label>
      <button class="btn" onclick="fetchAllSprints()">Fetch Sprints</button>
    </div>
    <div class="sprint-row" id="sprintRow" style="display:none; margin:1.1em 0;">
      <label>Sprint:
        <select id="sprintSelect" multiple></select>
      </label>
      <button class="btn" onclick="fetchAll()">Load Report</button>
    </div>
    <div id="loadingMessage" style="display:none; font-weight:bold; margin:10px 0;"></div>
    <div id="stats"></div>
    <table id="resultTable" style="display:none;">
      <thead>
        <tr>
          <th>Sprint</th>
          <th>Velocity</th>
          <th>Pulled</th>
          <th>Blocked</th>
          <th>Moved</th>
          <th>Type Changed</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
    <canvas id="chart" style="max-width:100%; margin-top:20px; display:none;"></canvas>
    <div id="details" style="margin-top:20px;"></div>
  </div>

  <script src="src/disruption.js"></script>
  <script>
    let jiraDomain = '', boardNum = '', sprints = [], boardTeams = [];

    document.getElementById('versionSelect').value = 'index_disruption.html';

    function switchVersion(page) {
      if (location.pathname.endsWith(page)) return;
      location.href = page;
    }

    function showLoading(msg) {
      const el = document.getElementById('loadingMessage');
      if (el) {
        el.textContent = msg || 'Loading...';
        el.style.display = '';
      }
    }

    function hideLoading() {
      const el = document.getElementById('loadingMessage');
      if (el) el.style.display = 'none';
    }

    async function fetchBoardTeam() {
      boardTeams = [];
      try {
        const cfgUrl = `https://${jiraDomain}/rest/agile/1.0/board/${boardNum}/configuration`;
        const cfgResp = await fetch(cfgUrl, { credentials: 'include' });
        if (!cfgResp.ok) return;
        const cfg = await cfgResp.json();
        const filterId = cfg.filter && cfg.filter.id;
        if (!filterId) return;
        const fResp = await fetch(`https://${jiraDomain}/rest/api/3/filter/${filterId}`, { credentials: 'include' });
        if (!fResp.ok) return;
        const fd = await fResp.json();
        const jql = fd.jql || '';
        const regex = /(?:"Team"|customfield_12600|cf\[12600\])\s*(?:=|in)\s*(\([^\)]*\)|"[^"\n]+")/gi;
        let m;
        while ((m = regex.exec(jql)) !== null) {
          let str = m[1].replace(/[()]/g, '');
          str.split(',').forEach(t => {
            t = t.replace(/"/g, '').trim();
            if (t && !boardTeams.includes(t)) boardTeams.push(t);
          });
        }
      } catch (e) {
        console.error('Failed to fetch board team', e);
      }
      console.log('Board teams:', boardTeams.join(', '));
    }

    async function fetchAllSprints() {
      jiraDomain = document.getElementById('jiraDomain').value.trim();
      boardNum = document.getElementById('boardNum').value.trim();
      if (!jiraDomain || !boardNum) return alert('Enter Jira domain and board number.');

      showLoading('Fetching sprints...');
      await fetchBoardTeam();

      let allSprintsArr = [];
      let startAt = 0;
      const maxResults = 50;
      let total = null;

      while (true) {
        const url = `https://${jiraDomain}/rest/agile/1.0/board/${boardNum}/sprint?maxResults=${maxResults}&startAt=${startAt}`;
        try {
          const resp = await fetch(url, { credentials: 'include' });
          if (!resp.ok) {
            const text = await resp.text();
            console.error('API Error Response:', resp.status, text);
            alert('API returned an error. See console for details.');
            hideLoading();
            return;
          }
          const data = await resp.json();
          if (data.values && data.values.length) {
            allSprintsArr = allSprintsArr.concat(data.values);
            total = data.total;
            startAt += data.values.length;
            if (data.isLast || allSprintsArr.length >= total) break;
          } else {
            break;
          }
        } catch (e) {
          console.error(e);
          alert('Failed to fetch sprints. CORS? Are you logged into Jira?');
          hideLoading();
          return;
        }
      }

      sprints = allSprintsArr.slice();
      populateSprintDropdown();
      hideLoading();
    }

    function populateSprintDropdown() {
      const sel = document.getElementById('sprintSelect');
      sel.innerHTML = '';
      for (let i = sprints.length - 1; i >= 0; i--) {
        const sprint = sprints[i];
        const opt = document.createElement('option');
        opt.value = sprint.id;
        let name = sprint.name || '(no name)';
        if (sprint.startDate) name += ' (' + sprint.startDate.substr(0, 10) + ')';
        opt.textContent = (sprint.state === 'active' ? 'ðŸŸ¢ ' : '') + name;
        sel.appendChild(opt);
      }
      document.getElementById('sprintRow').style.display = '';
    }

    async function fetchIssuesForSprint(sprintId) {
      const jql = encodeURIComponent(`Sprint = ${sprintId}`);
      let issues = [];
      let startAt = 0;
      const maxResults = 100;
      while (true) {
        const url = `https://${jiraDomain}/rest/api/3/search?jql=${jql}&fields=customfield_10016,customfield_10002&expand=changelog&startAt=${startAt}&maxResults=${maxResults}`;
        try {
          const resp = await fetch(url, { credentials: 'include' });
          if (!resp.ok) {
            const text = await resp.text();
            console.error('Failed to fetch sprint issues', resp.status, text);
            alert('Failed to fetch issues for sprint ' + sprintId);
            return null;
          }
          const data = await resp.json();
          issues = issues.concat(data.issues || []);
          startAt += data.issues ? data.issues.length : 0;
          if (!data.issues || startAt >= (data.total || 0)) break;
        } catch (e) {
          console.error('Error fetching issues for sprint', sprintId, e);
          alert('Error fetching sprint issues. See console for details.');
          return null;
        }
      }
      return issues;
    }

    async function fetchAll() {
      const sel = document.getElementById('sprintSelect');
      const selected = Array.from(sel.selectedOptions);
      if (!selected.length) return alert('Select at least one sprint.');

      showLoading('Loading sprint data...');
      if (!boardTeams.length) await fetchBoardTeam();

      const results = [];
      for (const opt of selected) {
        const sprintId = opt.value;
        const sprintName = opt.textContent;
        const sprintObj = sprints.find(s => String(s.id) === String(sprintId));
        const issues = await fetchIssuesForSprint(sprintId);
        if (issues === null) { hideLoading(); return; }
        const velocity = issues.reduce((sum, it) =>
          sum + (it.fields?.customfield_10016 || it.fields?.customfield_10002 || 0), 0);
        const events = issues.map(i => ({
          key: i.key,
          changelog: (i.changelog?.histories || []).map(h => ({
            field: h.items[0]?.field,
            from: h.items[0]?.fromString,
            to: h.items[0]?.toString,
            created: h.created
          }))
        }));
        const disruptions = window.aggregateDisruptions(events, sprintObj && sprintObj.startDate);
        results.push({ sprint: sprintName, velocity, ...disruptions });
      }

      const velocities = results.map(r => r.velocity);
      const avg = velocities.reduce((a, b) => a + b, 0) / (velocities.length || 1);
      const sd = Math.sqrt(velocities.reduce((s, v) => s + (v - avg) ** 2, 0) / (velocities.length || 1));
      const stats = document.getElementById('stats');
      stats.textContent = `Average Velocity: ${avg.toFixed(2)} | Standard Deviation: ${sd.toFixed(2)}`;

      const tbody = document.querySelector('#resultTable tbody');
      tbody.innerHTML = '';
      results.forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${r.sprint}</td><td>${r.velocity}</td><td>${r.pulled}</td><td>${r.blocked}</td><td>${r.moved}</td><td>${r.typeChanged}</td>`;
        tbody.appendChild(tr);
      });
      document.getElementById('resultTable').style.display = '';
      renderChart(results);
      renderDetails(results);
      hideLoading();
    }

    function renderDetails(results) {
      const container = document.getElementById('details');
      container.innerHTML = '';
      results.forEach(r => {
        const div = document.createElement('div');
        div.innerHTML = `<h3>${r.sprint}</h3>` +
          `<b>Pulled:</b> ${r.details.pulled.join(', ') || 'None'}<br>` +
          `<b>Blocked:</b> ${r.details.blocked.join(', ') || 'None'}<br>` +
          `<b>Moved:</b> ${r.details.moved.join(', ') || 'None'}<br>` +
          `<b>Type Changed:</b> ${r.details.typeChanged.join(', ') || 'None'}<br>`;
        container.appendChild(div);
      });
    }

    function renderChart(results) {
      const canvas = document.getElementById('chart');
      canvas.style.display = '';
      const ctx = canvas.getContext('2d');
      const labels = results.map(r => r.sprint);
      const data = {
        labels,
        datasets: [
          { label: 'Pulled', data: results.map(r => r.pulled), backgroundColor: '#f87171' },
          { label: 'Blocked', data: results.map(r => r.blocked), backgroundColor: '#fbbf24' },
          { label: 'Moved', data: results.map(r => r.moved), backgroundColor: '#60a5fa' },
          { label: 'Type Changed', data: results.map(r => r.typeChanged), backgroundColor: '#a78bfa' }
        ]
      };
      new Chart(ctx, { type: 'bar', data, options: { responsive: true, scales: { y: { beginAtZero: true } } } });
    }

  </script>
</body>
</html>
